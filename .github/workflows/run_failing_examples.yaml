name: Run all examples

on:
  pull_request:
    branches: [ main ]

# Global environment variables that might need adaption in the future
env:
  BACKEND: pytorch
  ENV_NAME: compsim_pinns
  ENV_FILE: env.yaml
  PYTHON_PACKAGE_MANAGER: conda

jobs:
  failing-examples:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies for GMSH
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libgl1 \
            libglu1-mesa \
            libsm6 \
            libxext6 \
            libxrender1 \
            libxcursor1 \
            libxft2 \
            libxinerama1
          sudo rm -rf /var/lib/apt/lists/*

      - name: Install Miniforge (no external action)
        shell: bash -l {0}
        run: |
          set -euo pipefail
          echo "Installing Miniforge/Mambaforge (self-hosted installer)..."

          # choose platform/arch to match available Miniforge builds
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            ARCH_TAG="x86_64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            # mac runners report arm64, Linux aarch64
            ARCH_TAG="aarch64"
          else
            ARCH_TAG="$ARCH"
          fi

          # Map to Miniforge naming for macOS / linux
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            if [[ "$ARCH_TAG" == "aarch64" ]]; then
              FN="Miniforge3-MacOSX-arm64.sh"
            else
              FN="Miniforge3-MacOSX-x86_64.sh"
            fi
          else
            if [[ "$ARCH_TAG" == "aarch64" ]]; then
              FN="Miniforge3-Linux-aarch64.sh"
            else
              FN="Miniforge3-Linux-x86_64.sh"
            fi
          fi

          # Download installer from latest releases (conda-forge/miniforge)
          URL="https://github.com/conda-forge/miniforge/releases/latest/download/${FN}"
          echo "Downloading $URL"
          curl -fsSL -o /tmp/miniforge.sh "$URL"
          chmod +x /tmp/miniforge.sh

          # Define installation directory and export as env variable for later steps
          export MINIFORGE_INSTALL_DIR="${HOME}/miniforge"
          echo "MINIFORGE_INSTALL_DIR=${MINIFORGE_INSTALL_DIR}" >> "$GITHUB_ENV"
          echo "Set MINIFORGE_INSTALL_DIR=$MINIFORGE_INSTALL_DIR"

          # Install Miniforge silently
          /tmp/miniforge.sh -b -p "${MINIFORGE_INSTALL_DIR}"

          # Put miniforge on PATH
          export PATH="${MINIFORGE_INSTALL_DIR}/bin:${PATH}"
          echo "${MINIFORGE_INSTALL_DIR}/bin" >> "$GITHUB_PATH"
          echo "Added MINIFORGE_INSTALL_DIR/bin to the PATH: ${PATH}"
          hash -r

          # Verify installation
          echo "package manager version: $($PYTHON_PACKAGE_MANAGER --version)"
          echo "python in base: $(python --version)"

          # Configure conda defaults (optional)
          $PYTHON_PACKAGE_MANAGER config --set channel_priority strict
          $PYTHON_PACKAGE_MANAGER config --add channels conda-forge

          # Install mamba into base for fast solving
          $PYTHON_PACKAGE_MANAGER install -y -n base mamba -c conda-forge

          # Check whether the envionment file is available
          if [ ! -f "$ENV_FILE" ]; then
            echo "Environment file '$ENV_FILE' not found; failing."
            exit 1
          fi

          # Update an existing or create a new environment
          if $PYTHON_PACKAGE_MANAGER env list | grep -q "^[[:space:]]*${ENV_NAME}[[:space:]]"; then
            echo "Updating existing env '$ENV_NAME' from $ENV_FILE"
            mamba env update -n "$ENV_NAME" -f "$ENV_FILE" --prune
          else
            echo "Creating env '$ENV_NAME' from $ENV_FILE"
            mamba env create -n "$ENV_NAME" -f "$ENV_FILE"
          fi

          echo "--- package manager info ---"
          $PYTHON_PACKAGE_MANAGER info
          echo "--- conda list (env $ENV_NAME) ---"
          $PYTHON_PACKAGE_MANAGER list -n "$ENV_NAME"

      - name: Run example scripts (60-seconds timeout each)
        shell: bash -l {0}
        run: |
          set -eo pipefail  # handle exit codes ourselves; avoid -u here

          TIME_LIMIT_SECONDS=60
          STATUS=0
          TIMEOUT_FILES=()

          # List of TF-backed examples
          TF_EXAMPLES=(
            "examples/beams/Euler_beam_simply_complex_static.py"
            "examples/beams/Euler_beam_simply_dynamic.py"
            "examples/beams/Euler_beam_simply_point_static.py"
            "examples/beams/Euler_beam_simply_static.py"
            "examples/deep_energy_examples/3d_examples/3d_block_torsion_nonlinear_displacement.py"
            "examples/deep_energy_examples/beam/Beam_under_shear_load_nonlinear.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_repulsive.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_repulsive_precise.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_precise.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_pretrained.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_repulsive.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_repulsive_precise.py"
            "examples/deep_energy_examples/lame/Lame_problem_quarter.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_data.py"
            "examples/elasticity_2d/linear_elasticity/four_point_bending/Beam2d_4point.py"
            "examples/elasticity_2d/linear_elasticity/four_point_bending/Beam2d_4point_step.py"
            "examples/elasticity_2d/linear_elasticity/four_point_bending/Beam2d_4point_compare_loading.py"
            "examples/elasticity_2d/linear_elasticity/inverse_lame/Lame_quarter_inverse_displacement.py"
            "examples/elasticity_2d/linear_elasticity/inverse_lame/Lame_quarter_inverse_mixed_variable.py"
            "examples/elasticity_2d/linear_elasticity/lame/Lame_problem.py"
            "examples/elasticity_2d/linear_elasticity/lame/Lame_problem_quarter_gmsh.py"
            "examples/elasticity_2d/linear_elasticity/lame/Lame_problem_quarter_gmsh_mixed_scale_structured.py"
            "examples/elasticity_2d/linear_elasticity/solid_beam/Beam2d.py"
            "examples/elasticity_2d/linear_elasticity/solid_beam/Beam2d_force_input.py"
            "examples/elasticity_2d/linear_elasticity/solid_beam/Beam2d_nondim_2.py"
            "examples/elasticity_2d/linear_elasticity/solid_rectangle/Rectangle_body_force_problem.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_normal_contact_fischer_burmeister_data_trained.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_normal_contact_fischer_burmeister_trained.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_pressure.py"
            "examples/elasticity_2d/normal_contact/single_patch/Contact_single_patch.py"
            "examples/elasticity_3d/linear_elasticity/time_dependent_examples/lame_under_internal_pressure_sin_load.py"
            "examples/heat_equation/heatEq1DPlusDiffusion.py"
            "examples/heat_equation/heatEq2D.py"
            examples/variational_examples/lame/Lame_quarter_mixed_inverse.py
          )

          # Failing examples
          FAILING_EXAMPLES=(
            "examples/deep_energy_examples/3d_examples/3d_block_torsion_nonlinear_displacement.py"
            "examples/deep_energy_examples/beam/Beam_under_shear_load_nonlinear.py"
            "examples/deep_energy_examples/hertzian/Hertzian_normal_contact_pretrained.py"
            "examples/elasticity_2d/linear_elasticity/lame/Lame_problem_quarter_gmsh.py"
            "examples/elasticity_2d/linear_elasticity/lame/Lame_problem_quarter_gmsh_mixed_scale_structured.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_normal_contact_fischer_burmeister_data_trained.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_normal_contact_fischer_burmeister_trained.py"
            "examples/elasticity_2d/normal_contact/hertzian/Hertzian_pressure.py"
            "examples/elasticity_2d/normal_contact/single_patch/Contact_single_patch.py"
            "examples/elasticity_2d/normal_contact/single_patch/Contact_single_patch_structured_planestrain.py"
            "examples/elasticity_3d/linear_elasticity/time_dependent_examples/lame_under_internal_pressure_sin_load.py"
            "examples/heat_equation/heatEq.py"
          )

          # Helper: check if file is in TF_EXAMPLES
          in_list() {
            local val="$1"
            for item in "${TF_EXAMPLES[@]}"; do
              [[ "$item" == "$val" ]] && return 0
            done
            return 1
          }

          in_failing_list() {
            local val="$1"
            for item in "${FAILING_EXAMPLES[@]}"; do
              [[ "$item" == "$val" ]] && return 0
            done
            return 1
          }

          GREEN='\033[0;32m'
          NC='\033[0m' # No Color / reset

          # NUL-safe find + sort; no process substitution
          find examples -type f -name '*.py' -print0 | sort -z | while IFS= read -r -d '' f; do
            # Select backend dynamically
            if in_list "$f"; then
              CURRENT_BACKEND="tensorflow.compat.v1"
            else
              CURRENT_BACKEND="$BACKEND"
            fi

            if in_failing_list "$f"; then
              echo
              echo "-----------------------------------------------------------------"
              echo -e "${GREEN}Running $f (timeout ${TIME_LIMIT_SECONDS}s)${NC}"
              set +e
              LOGFILE="$(mktemp -t runlog.XXXXXX)"

              DDE_BACKEND="$CURRENT_BACKEND" timeout --foreground --kill-after=1s "${TIME_LIMIT_SECONDS}s" \
                $PYTHON_PACKAGE_MANAGER run -n "$ENV_NAME" --no-capture-output python "$f" >"$LOGFILE" 2>&1
              rc=$?
              set -e

              if [ "$rc" -eq 124 ]; then
                echo "::warning file=$f::Timed out after ${TIME_LIMIT_SECONDS}s; killing lingering python for this file."

                # Kill any python that is running THIS script (TERM then KILL as fallback).
                # Works even if the wrapper double-forked.
                pkill -TERM -f -- "python[[:space:]][^ ]*${f}$" 2>/dev/null || true
                pkill -TERM -f -- "python3[[:space:]][^ ]*${f}$" 2>/dev/null || true
                sleep 1
                pkill -KILL -f -- "python[[:space:]][^ ]*${f}$" 2>/dev/null || true
                pkill -KILL -f -- "python3[[:space:]][^ ]*${f}$" 2>/dev/null || true

                TIMEOUT_FILES+=("$f")
              elif [ "$rc" -ne 0 ]; then
                echo "::error file=$f::Exited with code $rc"
                STATUS=1
                # Show output ONLY on error (not on timeout, not on success)
                echo "::group::Output from $f"
                cat "$LOGFILE"
                echo "::endgroup::"
              else
                echo "Finished $f"
              fi
            fi
          done

          # # Optional summary of timeouts
          # if [ "${#TIMEOUT_FILES[@]}" -gt 0 ]; then
          #   {
          #     echo "### Timed-out examples (${TIME_LIMIT_SECONDS}s)"
          #     for x in "${TIMEOUT_FILES[@]}"; do
          #       echo "- $x"
          #     done
          #   } >> "$GITHUB_STEP_SUMMARY"
          # fi

          exit $STATUS

